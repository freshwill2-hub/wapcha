<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL ê´€ë¦¬ - Copychu Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background-color: #0f172a; }
        .card { background-color: #1e293b; border-radius: 12px; }
        .input-field { 
            background-color: #334155; 
            border: 1px solid #475569;
            color: white;
        }
        .input-field:focus {
            border-color: #22d3ee;
            outline: none;
        }
        .input-field:disabled {
            background-color: #1e293b;
            color: #64748b;
            cursor: not-allowed;
        }
        .btn-primary {
            background: linear-gradient(135deg, #22d3ee, #0ea5e9);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .status-pending { color: #fbbf24; }
        .status-processing { color: #22d3ee; }
        .status-completed { color: #22c55e; }
        .status-error { color: #ef4444; }
        .log-time { color: #64748b; font-size: 0.75rem; min-width: 60px; }
        .log-info { color: #94a3b8; }
        .log-success { color: #22c55e; }
        .log-error { color: #ef4444; }
        .log-warning { color: #fbbf24; }
        .checkbox-custom {
            width: 18px;
            height: 18px;
            accent-color: #22d3ee;
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="fixed left-0 top-0 h-full w-52 bg-slate-900 p-4">
        <h1 class="text-xl font-bold text-cyan-400 mb-2">COPYCHU</h1>
        <p class="text-xs text-gray-500 mb-8">Automation Dashboard</p>
        
        <nav class="space-y-2">
            <a href="/" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-slate-800">
                <span>ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ
            </a>
            <a href="/pipeline.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-slate-800">
                <span>â–¶ï¸</span> íŒŒì´í”„ë¼ì¸
            </a>
            <a href="/urls.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-slate-800 text-cyan-400">
                <span>ğŸ”—</span> URL ê´€ë¦¬
            </a>
            <a href="/monitoring.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-slate-800">
                <span>ğŸ“º</span> ëª¨ë‹ˆí„°ë§
            </a>
            <a href="/gallery.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-slate-800">
                <span>ğŸ–¼ï¸</span> ê°¤ëŸ¬ë¦¬
            </a>
            <a href="/settings.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-slate-800">
                <span>âš™ï¸</span> ì„¤ì •
            </a>
        </nav>
        
        <div class="absolute bottom-4 left-4">
            <div class="flex items-center gap-2">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-green-400"></div>
                <span id="status-text" class="text-xs text-gray-500">ëŒ€ê¸°ì¤‘</span>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="ml-52 p-8">
        <h2 class="text-2xl font-bold mb-2">URL ê´€ë¦¬</h2>
        <p class="text-gray-400 mb-8">ì¹´í…Œê³ ë¦¬ URL í ë° ê°œë³„ ì œí’ˆ URL ê´€ë¦¬</p>

        <!-- íƒ­ -->
        <div class="flex gap-4 mb-6">
            <button id="tab-category" class="px-6 py-2 rounded-lg bg-cyan-500 text-white font-medium" onclick="showTab('category')">
                ğŸ“‚ ì¹´í…Œê³ ë¦¬ í
            </button>
            <button id="tab-product" class="px-6 py-2 rounded-lg bg-slate-700 text-gray-300" onclick="showTab('product')">
                ğŸ“¦ ê°œë³„ URL ì¶”ê°€
            </button>
            <button id="tab-list" class="px-6 py-2 rounded-lg bg-slate-700 text-gray-300" onclick="showTab('list')">
                ğŸ“‹ ë“±ë¡ëœ ì œí’ˆ
            </button>
            <button id="tab-logs" class="px-6 py-2 rounded-lg bg-slate-700 text-gray-300" onclick="showTab('logs')">
                ğŸ“œ ë¡œê·¸
            </button>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ í íƒ­ -->
        <div id="content-category" class="space-y-6">
            <!-- ì¹´í…Œê³ ë¦¬ URL ì¶”ê°€ -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">ì¹´í…Œê³ ë¦¬ URL ì¶”ê°€</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm text-gray-400 mb-2">ì˜¬ë¦¬ë¸Œì˜ ì¹´í…Œê³ ë¦¬ URL</label>
                        <input type="text" id="category-url" class="input-field w-full px-4 py-3 rounded-lg" 
                               placeholder="https://www.oliveyoung.co.kr/store/main/getBestList.do?dispCatNo=...">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ì¹´í…Œê³ ë¦¬ ì´ë¦„</label>
                        <input type="text" id="category-name" class="input-field w-full px-4 py-3 rounded-lg" 
                               placeholder="ì˜ˆ: ìŠ¤í‚¨ì¼€ì–´">
                    </div>
                </div>
                
                <!-- âœ… ìˆ˜ì§‘ ê°œìˆ˜ + í˜ì´ì§€ ì œí•œ ì„¤ì • -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ìµœëŒ€ ìˆ˜ì§‘ ê°œìˆ˜</label>
                        <input type="number" id="category-max" class="input-field w-full px-4 py-3 rounded-lg" 
                               value="100" min="1" max="1000">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">
                            <input type="checkbox" id="limit-pages-checkbox" class="checkbox-custom mr-2" onchange="togglePageLimit()">
                            í˜ì´ì§€ ìˆ˜ ì œí•œ
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="category-max-pages" class="input-field w-full px-4 py-3 rounded-lg" 
                                   value="10" min="1" max="100" disabled>
                            <span id="pages-label" class="text-cyan-400 text-sm whitespace-nowrap">ë¬´ì œí•œ</span>
                        </div>
                    </div>
                    <div class="md:col-span-2 flex items-end">
                        <button onclick="addCategory()" class="btn-primary px-6 py-3 rounded-lg font-medium">
                            â• íì— ì¶”ê°€
                        </button>
                    </div>
                </div>
                
                <p class="text-sm text-gray-500">
                    ğŸ’¡ íŒ: ì²´í¬ í•´ì œ ì‹œ ë§ˆì§€ë§‰ í˜ì´ì§€ê¹Œì§€ ìë™ ìˆ˜ì§‘ | SKU ì¤‘ë³µ ì œí’ˆì€ ìë™ ìŠ¤í‚µ
                </p>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ í ëª©ë¡ -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ì¹´í…Œê³ ë¦¬ í</h3>
                    <div class="flex gap-2">
                        <button onclick="processQueue()" id="btn-process" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium">
                            â–¶ï¸ í ì‹¤í–‰
                        </button>
                        <button onclick="clearCompleted()" class="px-4 py-2 rounded-lg text-sm bg-slate-700 hover:bg-slate-600">
                            ğŸ—‘ï¸ ì™„ë£Œ í•­ëª© ì‚­ì œ
                        </button>
                    </div>
                </div>
                
                <div id="category-queue" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <!-- ê°œë³„ URL ì¶”ê°€ íƒ­ -->
        <div id="content-product" class="hidden space-y-6">
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">ê°œë³„ ì œí’ˆ URL ì¶”ê°€</h3>
                
                <div class="flex gap-4 mb-4">
                    <input type="text" id="product-url" class="input-field flex-1 px-4 py-3 rounded-lg" 
                           placeholder="https://www.oliveyoung.co.kr/store/goods/getGoodsDetail.do?goodsNo=...">
                    <button onclick="addProductUrl()" class="btn-primary px-6 py-3 rounded-lg font-medium">
                        â• ì¶”ê°€
                    </button>
                </div>
                
                <p class="text-sm text-gray-500 mb-6">
                    ğŸ’¡ ì˜¬ë¦¬ë¸Œì˜ ì œí’ˆ ìƒì„¸ í˜ì´ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš” (SKU ì¤‘ë³µ ì‹œ ìë™ ìŠ¤í‚µ)
                </p>
                
                <!-- ì—¬ëŸ¬ URL í•œë²ˆì— ì¶”ê°€ -->
                <h4 class="font-medium mb-2">ì—¬ëŸ¬ URL í•œë²ˆì— ì¶”ê°€</h4>
                <textarea id="product-urls-bulk" class="input-field w-full px-4 py-3 rounded-lg h-32" 
                          placeholder="URLì„ í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                <button onclick="addBulkUrls()" class="btn-primary px-6 py-3 rounded-lg font-medium mt-4">
                    â• ì¼ê´„ ì¶”ê°€
                </button>
            </div>
            
            <!-- ìµœê·¼ ì¶”ê°€ëœ URL -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">ìµœê·¼ ì¶”ê°€ëœ URL</h3>
                <div id="recent-urls" class="space-y-2">
                    <p class="text-gray-500">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- ë“±ë¡ëœ ì œí’ˆ ëª©ë¡ íƒ­ -->
        <div id="content-list" class="hidden space-y-6">
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ë“±ë¡ëœ ì œí’ˆ ëª©ë¡</h3>
                    <div class="flex gap-2 items-center">
                        <span id="product-count" class="text-sm text-gray-400">0ê°œ ì œí’ˆ</span>
                        <button onclick="loadProducts()" class="px-4 py-2 rounded-lg text-sm bg-slate-700 hover:bg-slate-600">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-400 text-sm border-b border-slate-700">
                                <th class="pb-3 pl-4">ID</th>
                                <th class="pb-3">SKU</th>
                                <th class="pb-3">ì œí’ˆëª…</th>
                                <th class="pb-3">ê°€ê²©</th>
                                <th class="pb-3">ìˆ˜ì§‘ì¼</th>
                                <th class="pb-3">ìƒíƒœ</th>
                                <th class="pb-3">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="product-list">
                            <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </tbody>
                    </table>
                </div>
                
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="flex justify-center gap-2 mt-4">
                    <button onclick="prevPage()" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">ì´ì „</button>
                    <span id="page-info" class="px-4 py-2 text-gray-400">1 / 1</span>
                    <button onclick="nextPage()" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">ë‹¤ìŒ</button>
                </div>
            </div>
        </div>

        <!-- âœ… ë¡œê·¸ íƒ­ (ì‹œê°„ í‘œì‹œ) -->
        <div id="content-logs" class="hidden space-y-6">
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ì‹¤ì‹œê°„ ë¡œê·¸</h3>
                    <div class="flex gap-2">
                        <button onclick="clearLogs()" class="px-4 py-2 rounded-lg text-sm bg-slate-700 hover:bg-slate-600">
                            ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°
                        </button>
                        <label class="flex items-center gap-2 text-sm text-gray-400">
                            <input type="checkbox" id="auto-scroll" checked class="checkbox-custom">
                            ìë™ ìŠ¤í¬ë¡¤
                        </label>
                    </div>
                </div>
                
                <div id="log-container" class="bg-slate-900 rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm">
                    <p class="text-gray-500">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentPage = 0;
        const pageSize = 50;
        let totalProducts = 0;
        let logMessages = [];
        
        // âœ… í˜ì´ì§€ ì œí•œ ì²´í¬ë°•ìŠ¤ í† ê¸€
        function togglePageLimit() {
            const checkbox = document.getElementById('limit-pages-checkbox');
            const input = document.getElementById('category-max-pages');
            const label = document.getElementById('pages-label');
            
            if (checkbox.checked) {
                input.disabled = false;
                label.textContent = 'í˜ì´ì§€';
                label.classList.remove('text-cyan-400');
                label.classList.add('text-gray-400');
            } else {
                input.disabled = true;
                label.textContent = 'ë¬´ì œí•œ';
                label.classList.remove('text-gray-400');
                label.classList.add('text-cyan-400');
            }
        }
        
        // íƒ­ ì „í™˜
        function showTab(tab) {
            ['category', 'product', 'list', 'logs'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('bg-cyan-500', 'text-white');
                document.getElementById(`tab-${t}`).classList.add('bg-slate-700', 'text-gray-300');
            });
            
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.remove('bg-slate-700', 'text-gray-300');
            document.getElementById(`tab-${tab}`).classList.add('bg-cyan-500', 'text-white');
            
            if (tab === 'list') {
                loadProducts();
            }
        }
        
        // âœ… ì¹´í…Œê³ ë¦¬ ì¶”ê°€ (limitPages í¬í•¨)
        async function addCategory() {
            const url = document.getElementById('category-url').value.trim();
            const name = document.getElementById('category-name').value.trim();
            const maxProducts = parseInt(document.getElementById('category-max').value) || 100;
            const limitPages = document.getElementById('limit-pages-checkbox').checked;
            const maxPages = parseInt(document.getElementById('category-max-pages').value) || 10;
            
            if (!url) {
                alert('ì¹´í…Œê³ ë¦¬ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const response = await fetch('/api/url-queue/category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        url, 
                        name, 
                        maxProducts, 
                        maxPages: limitPages ? maxPages : 0,  // âœ… ì²´í¬ í•´ì œ ì‹œ 0 (ë¬´ì œí•œ)
                        limitPages 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('category-url').value = '';
                    document.getElementById('category-name').value = '';
                    loadUrlQueue();
                } else {
                    alert(data.error || 'ì¶”ê°€ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ì¹´í…Œê³ ë¦¬ ì‚­ì œ
        async function deleteCategory(id) {
            if (!confirm('ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await fetch(`/api/url-queue/category/${id}`, { method: 'DELETE' });
                loadUrlQueue();
            } catch (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // í ì‹¤í–‰
        async function processQueue() {
            try {
                const response = await fetch('/api/url-queue/process', { method: 'POST' });
                const data = await response.json();
                
                if (!data.success) {
                    alert(data.error || 'ì‹¤í–‰ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ì™„ë£Œ í•­ëª© ì‚­ì œ
        async function clearCompleted() {
            const queue = await (await fetch('/api/url-queue')).json();
            
            for (const cat of queue.categories) {
                if (cat.status === 'completed') {
                    await fetch(`/api/url-queue/category/${cat.id}`, { method: 'DELETE' });
                }
            }
            
            loadUrlQueue();
        }
        
        // ê°œë³„ URL ì¶”ê°€
        async function addProductUrl() {
            const url = document.getElementById('product-url').value.trim();
            
            if (!url) {
                alert('ì œí’ˆ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const response = await fetch('/api/url-queue/product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('product-url').value = '';
                    alert(`URLì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (SKU: ${data.sku})`);
                    loadRecentUrls();
                } else {
                    alert(data.error || 'ì¶”ê°€ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ì¼ê´„ URL ì¶”ê°€
        async function addBulkUrls() {
            const text = document.getElementById('product-urls-bulk').value.trim();
            const urls = text.split('\n').filter(u => u.trim());
            
            if (urls.length === 0) {
                alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            let success = 0;
            let failed = 0;
            let duplicates = 0;
            
            for (const url of urls) {
                try {
                    const response = await fetch('/api/url-queue/product', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: url.trim() })
                    });
                    
                    const data = await response.json();
                    if (data.success) success++;
                    else if (data.error?.includes('ì´ë¯¸ ë“±ë¡')) duplicates++;
                    else failed++;
                } catch {
                    failed++;
                }
            }
            
            alert(`ì¶”ê°€ ì™„ë£Œ: ì„±ê³µ ${success}ê°œ, ì¤‘ë³µ ${duplicates}ê°œ, ì‹¤íŒ¨ ${failed}ê°œ`);
            document.getElementById('product-urls-bulk').value = '';
            loadRecentUrls();
        }
        
        // âœ… URL í ë¡œë“œ (ë¬´ì œí•œ í‘œì‹œ)
        async function loadUrlQueue() {
            try {
                const response = await fetch('/api/url-queue');
                const queue = await response.json();
                
                const container = document.getElementById('category-queue');
                
                if (!queue.categories || queue.categories.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                    return;
                }
                
                container.innerHTML = queue.categories.map((cat, index) => {
                    const pagesText = cat.maxPages === 0 ? 'ë¬´ì œí•œ' : `${cat.maxPages}í˜ì´ì§€`;
                    const pagesClass = cat.maxPages === 0 ? 'text-cyan-400' : 'text-yellow-400';
                    
                    return `
                    <div class="flex items-center gap-4 p-4 bg-slate-800 rounded-lg">
                        <span class="text-gray-500">â˜°</span>
                        <span class="w-8 h-8 flex items-center justify-center bg-slate-700 rounded-full text-sm">${index + 1}</span>
                        <div class="flex-1">
                            <p class="font-medium">${cat.name || 'ì´ë¦„ ì—†ìŒ'}</p>
                            <p class="text-sm text-gray-400 truncate">${cat.url.substring(0, 60)}...</p>
                        </div>
                        <span class="text-sm text-cyan-400">ìµœëŒ€ ${cat.maxProducts}ê°œ</span>
                        <span class="text-sm ${pagesClass}">${pagesText}</span>
                        <span class="status-${cat.status} text-sm">${getStatusText(cat.status)}</span>
                        <button onclick="deleteCategory('${cat.id}')" class="text-red-400 hover:text-red-300 px-2">ğŸ—‘ï¸</button>
                    </div>
                `}).join('');
                
            } catch (error) {
                console.error('URL í ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        function getStatusText(status) {
            const texts = {
                'pending': 'â³ ëŒ€ê¸°ì¤‘',
                'processing': 'ğŸ”„ ì²˜ë¦¬ì¤‘',
                'completed': 'âœ… ì™„ë£Œ',
                'error': 'âŒ ì˜¤ë¥˜'
            };
            return texts[status] || status;
        }
        
        // ìµœê·¼ URL ë¡œë“œ
        async function loadRecentUrls() {
            try {
                const response = await fetch('/api/oliveyoung/products?limit=10');
                const data = await response.json();
                
                const container = document.getElementById('recent-urls');
                
                if (!data.list || data.list.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">ë“±ë¡ëœ URLì´ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }
                
                container.innerHTML = data.list.map(p => `
                    <div class="flex items-center gap-4 p-3 bg-slate-800 rounded-lg">
                        <div class="flex-1">
                            <p class="text-sm font-medium">${p.title_kr || p.sku || 'ì œëª© ì—†ìŒ'}</p>
                            <p class="text-xs text-gray-500">SKU: ${p.sku || '-'}</p>
                        </div>
                        <span class="text-xs text-gray-400">${new Date(p.collected_at).toLocaleDateString()}</span>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('ìµœê·¼ URL ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ì œí’ˆ ëª©ë¡ ë¡œë“œ
        async function loadProducts() {
            try {
                const response = await fetch(`/api/oliveyoung/products?limit=${pageSize}&offset=${currentPage * pageSize}`);
                const data = await response.json();
                
                totalProducts = data.total;
                document.getElementById('product-count').textContent = `${totalProducts}ê°œ ì œí’ˆ`;
                
                const totalPages = Math.ceil(totalProducts / pageSize);
                document.getElementById('page-info').textContent = `${currentPage + 1} / ${totalPages || 1}`;
                
                const tbody = document.getElementById('product-list');
                
                if (!data.list || data.list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.list.map(p => `
                    <tr class="border-b border-slate-700 hover:bg-slate-800">
                        <td class="py-3 pl-4">${p.Id}</td>
                        <td class="py-3 text-sm text-cyan-400 font-mono">${p.sku || '-'}</td>
                        <td class="py-3">${(p.title_kr || '').substring(0, 30)}${(p.title_kr || '').length > 30 ? '...' : ''}</td>
                        <td class="py-3">â‚©${(p.price_current || 0).toLocaleString()}</td>
                        <td class="py-3 text-sm text-gray-400">${p.collected_at ? new Date(p.collected_at).toLocaleDateString() : '-'}</td>
                        <td class="py-3">
                            ${p.product_images ? '<span class="text-green-400">âœ… ìŠ¤í¬ë©ë¨</span>' : '<span class="text-yellow-400">â³ ëŒ€ê¸°</span>'}
                        </td>
                        <td class="py-3">
                            <button onclick="deleteProduct(${p.Id})" class="text-red-400 hover:text-red-300 text-sm">ì‚­ì œ</button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('ì œí’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ì œí’ˆ ì‚­ì œ
        async function deleteProduct(id) {
            if (!confirm('ì´ ì œí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await fetch(`/api/oliveyoung/products/${id}`, { method: 'DELETE' });
                loadProducts();
            } catch (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // í˜ì´ì§€ë„¤ì´ì…˜
        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                loadProducts();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(totalProducts / pageSize);
            if (currentPage < totalPages - 1) {
                currentPage++;
                loadProducts();
            }
        }
        
        // âœ… ë¡œê·¸ ì¶”ê°€ (ì‹œê°„ í‘œì‹œ)
        function addLogMessage(log) {
            const container = document.getElementById('log-container');
            
            // ì²« ë¡œê·¸ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì œê±°
            if (logMessages.length === 0) {
                container.innerHTML = '';
            }
            
            logMessages.push(log);
            
            // ìµœëŒ€ 500ê°œ ìœ ì§€
            if (logMessages.length > 500) {
                logMessages.shift();
                container.removeChild(container.firstChild);
            }
            
            const logDiv = document.createElement('div');
            logDiv.className = 'flex gap-2 py-1';
            
            // âœ… ì‹œê°„ í‘œì‹œ
            const time = log.timeFormatted || new Date(log.timestamp).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            
            logDiv.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-${log.type}">${log.message}</span>
            `;
            
            container.appendChild(logDiv);
            
            // ìë™ ìŠ¤í¬ë¡¤
            if (document.getElementById('auto-scroll').checked) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLogs() {
            logMessages = [];
            document.getElementById('log-container').innerHTML = '<p class="text-gray-500">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>';
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        socket.on('state', (state) => {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            if (state.status === 'running') {
                dot.className = 'w-2 h-2 rounded-full bg-cyan-400 animate-pulse';
                text.textContent = state.currentPhase || 'ì‹¤í–‰ì¤‘';
            } else if (state.status === 'error') {
                dot.className = 'w-2 h-2 rounded-full bg-red-400';
                text.textContent = 'ì˜¤ë¥˜';
            } else {
                dot.className = 'w-2 h-2 rounded-full bg-green-400';
                text.textContent = 'ëŒ€ê¸°ì¤‘';
            }
        });
        
        socket.on('urlQueue', (queue) => {
            loadUrlQueue();
        });
        
        // âœ… ì‹¤ì‹œê°„ ë¡œê·¸ ìˆ˜ì‹ 
        socket.on('log', (log) => {
            addLogMessage(log);
        });
        
        // âœ… ê¸°ì¡´ ë¡œê·¸ ë¡œë“œ
        socket.on('logs', (existingLogs) => {
            existingLogs.forEach(log => addLogMessage(log));
        });
        
        // ì´ˆê¸° ë¡œë“œ
        loadUrlQueue();
        loadRecentUrls();
    </script>
</body>
</html>